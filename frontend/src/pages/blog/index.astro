---
import Base from "@components/layouts/base.astro";
import { getBlogPosts } from "@features/blog/blog.service";
import BlogCard from "@features/blog/components/BlogCard.astro";

import type { IBlog } from "../../features/blog/blog.type";
import type { ISbResult } from "@sb/storyblok.types";

const url = new URL(Astro.request.url);
const tagsParam = url.searchParams.get("tags");
const filterTags = tagsParam ? tagsParam.split(",").filter(Boolean) : [];

let stories: ISbResult<IBlog>[] = [];

try {
    const blogData = await getBlogPosts({
        tags: filterTags.length > 0 ? filterTags : undefined
    });
    if (blogData) {
        stories = blogData;
    }
} catch (error: any) {
    if (error?.status === 404) {
        return Astro.redirect("/404");
    }
}
---

<Base title="Blog" description="Read articles about software development, web technologies, and personal projects by Joshua Pascual.">
    <main class="container mx-auto max-w-screen-md px-4">
        <section class="grid gap-4 mb-10">
            {stories.length > 0 ? (
                stories.map((story) => (
                    <BlogCard blog={story.content} slug={story.slug} />
                ))
            ) : (
                <p class="text-text-secondary text-center py-8">No articles found.</p>
            )}
        </section>
    </main>
</Base>
