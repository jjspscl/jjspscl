---
import { TURNSTILE_SITE_KEY } from "astro:env/client";
import { TURNSTILE_SECRET_KEY } from "astro:env/server";

import Base from "../../components/layouts/base.astro";
import { ContactFormWrapper, contactFormSchema } from "../../features/contact";
import { checkAndIncrementDailyLimit, storeContactSubmission } from "../../features/db";

const TURNSTILE_VERIFY_URL = "https://challenges.cloudflare.com/turnstile/v0/siteverify";

interface TurnstileResponse {
    success: boolean;
    "error-codes"?: string[];
}

async function verifyTurnstileToken(token: string): Promise<{ success: boolean; error?: string }> {
    try {
        const formData = new FormData();
        formData.append("secret", TURNSTILE_SECRET_KEY);
        formData.append("response", token);

        const response = await fetch(TURNSTILE_VERIFY_URL, {
            method: "POST",
            body: formData,
        });

        if (!response.ok) {
            return { success: false, error: "Turnstile service unavailable" };
        }

        const result = (await response.json()) as TurnstileResponse;
        return { success: result.success, error: result["error-codes"]?.join(", ") };
    } catch (error) {
        console.error("Turnstile verification error:", error);
        return { success: false, error: "Failed to verify token" };
    }
}

if (Astro.request.method === "POST") {
    const contentType = Astro.request.headers.get("Content-Type") || "";
    const headers = Astro.request.headers;
    const ip = headers.get("CF-Connecting-IP") || headers.get("X-Forwarded-For") || "unknown";
    
    const db = Astro.locals.runtime?.env?.DB;

    try {
        let rawData: { name?: string; email?: string; message?: string; turnstileToken?: string };

        if (contentType.includes("application/json")) {
            rawData = await Astro.request.json();
        } else {
            const formData = await Astro.request.formData();
            rawData = {
                name: formData.get("name")?.toString().trim(),
                email: formData.get("email")?.toString().trim(),
                message: formData.get("message")?.toString().trim(),
                turnstileToken: formData.get("cf-turnstile-response")?.toString(),
            };
        }

        const turnstileToken = rawData.turnstileToken;

        if (!turnstileToken) {
            return new Response(
                JSON.stringify({ error: "Please complete the verification challenge." }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const verification = await verifyTurnstileToken(turnstileToken);
        
        if (!verification.success) {
            return new Response(
                JSON.stringify({ error: "Security verification failed. Please try again." }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const limitCheck = await checkAndIncrementDailyLimit(db, ip);
        
        if (!limitCheck.allowed) {
            return new Response(
                JSON.stringify({ error: "Daily message limit reached. Please try again tomorrow." }),
                { status: 429, headers: { "Content-Type": "application/json" } }
            );
        }

        const validationResult = contactFormSchema.safeParse({
            name: rawData.name?.trim() ?? "",
            email: rawData.email?.trim() ?? "",
            message: rawData.message?.trim() ?? "",
        });
        
        if (!validationResult.success) {
            const errors = validationResult.error.errors.map(e => e.message).join(", ");
            return new Response(
                JSON.stringify({ error: errors }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const { name, email, message } = validationResult.data;

        const metadata = {
            ip,
            userAgent: headers.get("User-Agent") || "unknown",
            country: headers.get("CF-IPCountry") || "unknown",
            city: headers.get("CF-IPCity") || "unknown",
            turnstileToken,
        };

        await storeContactSubmission(db, { name, email, message }, metadata);

        console.log("Contact form submission:", { name, email, message, metadata, remaining: limitCheck.remaining });

        return new Response(
            JSON.stringify({ success: true, remaining: limitCheck.remaining }),
            { status: 200, headers: { "Content-Type": "application/json" } }
        );
    } catch (error) {
        console.error("Error processing request:", error);
        return new Response(
            JSON.stringify({ error: "An error occurred. Please try again later." }),
            { status: 500, headers: { "Content-Type": "application/json" } }
        );
    }
}

const siteKey = TURNSTILE_SITE_KEY;
---
<Base>
    <main class="container mx-auto md:mx-auto md:max-w-screen-md h-full py-10 px-4">
        <section class="max-w-xl mx-auto">
            <h1 class="text-3xl md:text-4xl font-bold text-center mb-8">Contact</h1>
            <ContactFormWrapper client:load turnstileSiteKey={siteKey} />
        </section>
    </main>
</Base>