---
import { TURNSTILE_SITE_KEY } from "astro:env/client";
import { TURNSTILE_SECRET_KEY, RESEND_API_KEY } from "astro:env/server";

import Base from "../../components/layouts/base.astro";
import {
    ContactFormWrapper,
    contactFormSchema,
    setDatabase,
    setTurnstileSecretKey,
    verifyTurnstileToken,
    checkRateLimit,
    getRateLimitStatus,
    submitContactForm,
} from "../../features/contact";
import { setResendApiKey } from "../../features/resend";

const headers = Astro.request.headers;
const ip = headers.get("CF-Connecting-IP") || headers.get("X-Forwarded-For") || "unknown";
setDatabase(Astro.locals.runtime?.env?.DB);
setTurnstileSecretKey(TURNSTILE_SECRET_KEY);
setResendApiKey(RESEND_API_KEY);

const initialRateLimitStatus = await getRateLimitStatus(ip);

if (Astro.request.method === "POST") {
    const contentType = Astro.request.headers.get("Content-Type") || "";

    try {
        let rawData: { name?: string; email?: string; message?: string; turnstileToken?: string };

        if (contentType.includes("application/json")) {
            rawData = await Astro.request.json();
        } else {
            const formData = await Astro.request.formData();
            rawData = {
                name: formData.get("name")?.toString().trim(),
                email: formData.get("email")?.toString().trim(),
                message: formData.get("message")?.toString().trim(),
                turnstileToken: formData.get("cf-turnstile-response")?.toString(),
            };
        }

        const turnstileToken = rawData.turnstileToken;

        if (!turnstileToken) {
            return new Response(
                JSON.stringify({ error: "Please complete the verification challenge." }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const verification = await verifyTurnstileToken(turnstileToken);
        
        if (!verification.success) {
            return new Response(
                JSON.stringify({ error: "Security verification failed. Please try again." }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const limitCheck = await checkRateLimit(ip);
        
        if (!limitCheck.allowed) {
            return new Response(
                JSON.stringify({ error: "Daily message limit reached. Please try again tomorrow." }),
                { status: 429, headers: { "Content-Type": "application/json" } }
            );
        }

        const validationResult = contactFormSchema.safeParse({
            name: rawData.name?.trim() ?? "",
            email: rawData.email?.trim() ?? "",
            message: rawData.message?.trim() ?? "",
        });
        
        if (!validationResult.success) {
            return new Response(
                JSON.stringify({ error: validationResult.error.errors.map(e => e.message).join(", ") }),
                { status: 400, headers: { "Content-Type": "application/json" } }
            );
        }

        const { name, email, message } = validationResult.data;

        const metadata = {
            ip,
            userAgent: headers.get("User-Agent") || "unknown",
            country: headers.get("CF-IPCountry") || "unknown",
            city: headers.get("CF-IPCity") || "unknown",
            turnstileToken,
        };

        await submitContactForm({ name, email, message }, metadata);

        return new Response(
            JSON.stringify({ success: true, remaining: limitCheck.remaining }),
            { status: 200, headers: { "Content-Type": "application/json" } }
        );
    } catch (error) {
        console.error("Error processing request:", error);
        return new Response(
            JSON.stringify({ error: "An error occurred. Please try again later." }),
            { status: 500, headers: { "Content-Type": "application/json" } }
        );
    }
}

const siteKey = TURNSTILE_SITE_KEY;
const isRateLimited = !initialRateLimitStatus.allowed;
---
<Base>
    <main class="container mx-auto md:mx-auto md:max-w-screen-md h-full py-10 px-4">
        <section class="max-w-xl mx-auto">
            {isRateLimited ? (
                <div class="flex min-h-[400px] flex-col items-center justify-center">
                    <div class="text-center">
                        <div class="mb-4 text-5xl">âœ“</div>
                        <h2 class="mb-2 text-2xl font-bold text-white">Message Already Sent!</h2>
                        <p class="text-gray-400">
                            You've already sent your message for today. Please try again tomorrow.
                        </p>
                        <div class="mt-6 flex items-center justify-center gap-2 text-gray-500" id="redirect-container">
                            <svg class="h-4 w-4 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span class="text-sm">Redirecting in <span id="countdown">5</span>s...</span>
                        </div>
                    </div>
                </div>
                <script>
                    (() => {
                        const countdownEl = document.getElementById('countdown');
                        let count = 5;
                        let redirectCancelled = false;
                        
                        const interval = setInterval(() => {
                            if (redirectCancelled) return;
                            count--;
                            if (countdownEl) countdownEl.textContent = String(count);
                            if (count <= 0) {
                                clearInterval(interval);
                                if (!redirectCancelled) {
                                    window.location.href = '/';
                                }
                            }
                        }, 1000);

                        const cleanup = () => {
                            redirectCancelled = true;
                            clearInterval(interval);
                        };

                        document.addEventListener('astro:before-preparation', cleanup);
                        document.addEventListener('astro:before-swap', cleanup);
                        window.addEventListener('beforeunload', cleanup);
                        window.addEventListener('pagehide', cleanup);
                    })();
                </script>
            ) : (
                <ContactFormWrapper client:load turnstileSiteKey={siteKey} />
            )}
        </section>
    </main>
</Base>