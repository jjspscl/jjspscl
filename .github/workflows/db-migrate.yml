name: D1 Database Migrations

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/db/**'
      - 'frontend/wrangler.toml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

jobs:
  migrate:
    runs-on: ubuntu-latest
    name: Run D1 Migrations
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Run Schema Migration
        working-directory: frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Running D1 schema migration..."
          wrangler d1 execute contact-limits --remote --file=./db/schema.sql
          echo "Migration complete!"

      - name: Verify Tables
        working-directory: frontend
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Verifying tables..."
          wrangler d1 execute contact-limits --remote --command="SELECT name FROM sqlite_master WHERE type='table';"
